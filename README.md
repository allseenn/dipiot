# Курсовая (дипломная) работа по курсу

**Программирование на языке С (IOT)**

**Электронно-измерительный комплекс фиксации, хранения и визуализации параметров окружающей среды**


Группа: 5471

Ростислав Ромашин

## Введение

В соответствии с [требованиями курсового проекта](https://gbcdn.mrgcdn.ru/uploads/asset/6059669/attachment/b96792ea81b800e90a0a38930767b51b.pdf) был разработан и реализован комплекс по мониторингу окружающией среды, который состоит из следующих компонентов:

1. BME680 - Датчик газа, давления, температуры и влажности с низким энергопотреблением
    - BSEC - проприетарное ПО
    - BME68x-Sensor-API - открытое ПО 
2. Odroid-X2 - Клиентский контроллер на базе CPU ARMv7
    - ArchLinux
    - Клиент mqtt на языке С
    - Sense - приложение сбора метрик с датчика BME680 на языке С с помощью открытых API
    - Web-сервер на языке С
3. IBM PC - Серверная часть на базе CPU x86
    - Node-Red
    - Mosquitto
    - InfluxDB
    - Grafana
4. ЛВС - с возможностью организации интернет доступа ко всем вышеперечисленным компонентам
    - OpenWRT router + ddns
    - Nginx


## 1. BME680

Датчик газа, давления, температуры и влажности с низким энергопотреблением от компании BOSH.
BME680 — это цифровой 4-в-1 датчик, измеряющий газ, влажность, давление и температуру на основе проверенных принципов измерения. Модуль датчика помещен в крайне компактный корпус с металлической крышкой LGA, имеющий размеры всего 3,0 × 3,0 мм² и максимальную высоту 1,00 мм (0,93 ± 0,07 мм). Его небольшие размеры и низкое энергопотребление позволяют интегрировать его в устройства, работающие от батареи или в устройства с частотной связью, такие как мобильные телефоны или носимые устройства.

Данный датчик 4-в-1 куплен на [алиэкспресс](https://aliexpress.ru/item/0_4001042311625.html) за 353 рубля. Что, примерно в десять раз дороже [классических датчиков](https://aliexpress.ru/item/32228095913.html) "одномерных" датчиков. В чем же преимущества и недостатки? 

### Программное обеспечение BSEC

Датчик BME680 предназначен для использования вместе с решением Bosch Software Environmental Cluster (BSEC) и API датчика BME6xy, чтобы раскрыть его полный потенциал. Программное обеспечение BSEC включает интеллектуальные алгоритмы, которые позволяют использовать такие сценарии, как мониторинг качества воздуха по различным индексам.

Датчика оснащен специальной пластиной, нагревающейся до 320 и более градусов по цельсию. Данная пластина замеряет сопротивление воздуха. В интернете можно встретить много отрицательных отзывов про точность данных датчиков. Но, просмотрев даташиты производителя понимаешь неоднозначность плохих выводов. С одной стороны допустимая погрешность измеряемой температуры +-1 градус по Цельсию не позволит это делать в больницах. Но, прибор не позиционируется как высокоточный и медицинский.  Датчик "по-старинке" подсоединяют к системам на подобие arduino или esp, и наблюдают большие разночтений с рядом стоящими бытовыми приборами. Например, темперетура воздуха вопреки погрешности может быть больше чем на 5 градусов от бытового термометра. Дело тут не в оригинальности продукта, хоть и существует большая доля вероятности купить брак. Дело именно в расчетах. Датчик по своей сути является микроконтроллером со своими регистрами и своей проприетарной логикой работы. Для расчета показателей мощностей ардуино не достаточно. Можно запустить датчик в форсированном режиме и он будет сбрасывать постоянно неточную информацию. Весь смысл заключается именно в закрытом проприетарном ПО.  Но именно оно участвует в сложнейших расчетах и управлении режимов датчика. Во первых для того чтобы снять показания сопротивления воздуха, необходимо нагреть пластину до 320 градусов. Этот процесс кратковременный, но все же нагрев отражается на термодатчике. Следовательно нужно замеры температуры делать в промежутках между нагревами. При расчете температуры, проприетарным ПО учитываются остальные параметры, такие как влажность и давление. О сложности ПО говорит и тот факт, что драйвера для датчика BME680 и BME688 используются одни и те же. А вот датчик BME688 позиционируется уже как AI (ИИ).

Программное обеспечение BSEC от Bosch Sensortec доступно в виде закрытого двоичного файла, который будет предоставлен через Лицензионное Соглашение на Программное Обеспечение (SLA) на сайте Bosch Sensortec (https://www.bosch-sensortec.com/bst/products/all_products/BSEC).  Забегая вперед замечу, что пока мне с проприетарным ПО разобраться не удалось, из-за его сложности.

Ключевые особенности системы аппаратного и программного обеспечения:

Расчет температуры окружающего воздуха вне устройства (например, телефона)
Расчет относительной влажности окружающего воздуха вне устройства
Расчет индекса качества воздуха (IAQ) вне устройства
Кроме того, программные алгоритмы обрабатывают компенсацию влажности, базовую линию, а также коррекцию долгосрочного дрейфа сигнала газового датчика.


### BME68x-Sensor-API 

API датчика охватывает базовую коммуникацию с датчиком и функции компенсации данных, и доступен как открытый исходный код на Github (https://github.com/BoschSensortec/BME68x-Sensor-API). Т.е. функционал открытого ПО ограничен. Бош бережно хранит алгоритм расчетов в секрете. Более того, они удалили свой старый открытый репозиторий, который содержал более "простой" для понимания драйвер. В новом репозитории, упомянутом выше, лежит другой драйвер, который требует наличия "тяжелого" COINES SDK.

[Cтарый](https://github.com/BoschSensortec/BME680_driver/releases) репозиторий с открытым драйвером датчика BME680 до сих пор красуется в последнем даташите. 
Но, нашел старый открытый драйвер 3.5.9 на стороннем репозитории https://github.com/wintersteiger/BME680_driver. 
Драйвер содержит открытие API. Для того чтобы начать получать или записывать информацию на датчик, необходимо самостоятельно написать основную программу для конкретной платформы и операционной системы, которая с помощью апи будет обращаться через драйвер к датчику.
Т.к. готовых примеров не нашел, то за основу взял решение для Raspberry Pi, но для более старого датчика BME280  https://www.waveshare.com/w/upload/b/ba/BME280-Environmental-Sensor-Demo-Code.7z. Код от BME280 частично совместим и позволяет отображать только температуру. "Подсмотрев" основную логику организации взаимодействия, удалось заставить шайтан-машину работать).

## Odroid-X2

Данный малино-подобный мини-ПК использовал в своем прошлом ДЗ для [веб-сервера и чатов](https://github.com/allseenn/ciot/tree/main/03.Tasks).

Основной проблемой [Odroid-X2](https://www.hardkernel.com/shop/odroid-x2/) является его "древность". Снят с поддержки лет 10 назад. Но, по мощности не уступает многим Raspberry даже сегодня. Официальной последней версией была Ubuntu 14.04. Умельцы сделали неофициальный образ на базе Ubuntu 16.04. Для языка СИ это не проблема, но хотелось, что-то посвежее. 

### ArchLinux

И чисто случайно обнаружил [образ](https://archlinuxarm.org/platforms/armv7/samsung/odroid-x2) для odroid в официальном хранилище ArchLinux. Данная система позиционируется как более профессиональная версия Linux и одной из особенностей являются Rolling обновления. Т.е. как таковых версий у нее нету, переодически накатываются самые последние обновления и все. Таким образом получаем самое свежее ядро, библиотеки и ПО:

```
$ uname -a
Linux odroid 6.9.6-3-ARCH #1 SMP PREEMPT Thu Jun 27 07:33:29 MDT 2024 armv7l GNU/Linux

$ cat /etc/os-release 
NAME="Arch Linux ARM"
PRETTY_NAME="Arch Linux ARM"
ID=archarm
ID_LIKE=arch
BUILD_ID=rolling
ANSI_COLOR="38;2;23;147;209"
HOME_URL="https://archlinuxarm.org/"
DOCUMENTATION_URL="https://archlinuxarm.org/wiki"
SUPPORT_URL="https://archlinuxarm.org/forum"
BUG_REPORT_URL="https://github.com/archlinuxarm/PKGBUILDs/issues"
LOGO=archlinux-logo
```

### Клиент mqtt

Основной проблемой является, то что пакета с библиотекой paho-mqtt-c нет в офрепозиториях ArchLinux.
Пришлось собирать ее самостоятельно из исходников скачанных с [официального репозитория](https://github.com/eclipse/paho.mqtt.c).

```bash
make
make install
```

Написал программу для [mqtt-клиента](https://github.com/allseenn/ciot/blob/main/04.Tasks/mqtt/mqtt.c).
Програма позволяет с помощью ключей командной строки задать следующие параметры:

- -i - ip-адрес и порт mqtt-сервера
- -u - имя пользователя
- -p - пароль

Программа позволяет также принимать информацию со стандартного потока ввода, до 4-x аргументов в следующем порядке:

- температура
- давление
- влажность
- газ

### 

Используя раннее полученный опыт с драйверами BME280, написал программу для mqtt-клиента.


Настройка Nod-Red

настройка infulux-db

```
from(bucket: "IoT")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "mqtt_consumer")
  |> filter(fn: (r) => r["_field"] == "value")
  |> filter(fn: (r) => r["host"] == "e81d2a776ed2")
  |> filter(fn: (r) => r["topic"] == "gas" or r["topic"] == "humidity" or r["topic"] == "pressure" or r["topic"] == "temperature")
  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```




### Список официальной литературы:

1. [BME680 – Datasheet 1.9 02-2024](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme680-ds001.pdf) - 53 страниц
2. [BME680 – Datasheet 1.3 07-2019](https://github.com/allseenn/dipiot/blob/main/docs/CZ_BME680_BOSCH_0001.pdf) - 54 страниц
3. [BSEC Integration Guideline](https://github.com/allseenn/dipiot/blob/main/docs/BST-BME680-Integration-Guide-AN008-47.pdf) - 56 страниц
4. [BSEC Binary Size Information](https://github.com/allseenn/dipiot/blob/main/docs/BSEC2%20Binary%20Size%20Information.pdf) -3 страницы
5. [BME68x - Shipment packaging details](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme68x-sp000.pdf) - 9 страниц
6. [BME680 – Application Note](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme680-an014.pdf) - 13 страниц
7. [BME680 Integrated Environmental Unit](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme680-fl000.pdf) - 2 страниц
8. [BME680: Handling, Soldering and Mounting Instructions](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme680-hs000.pdf) - 16 страниц
9. [BME680 Shuttle board 3.0 flyer](https://github.com/allseenn/dipiot/blob/main/docs/bst-bme680-sf000.pdf) - 2 страницы
10. [Release Notes 2.5.0.2](https://github.com/allseenn/dipiot/blob/main/docs/Release%20Notes_BSEC_2.5.0.2_Website_Release_11012024.pdf)

Итого, около 200 страниц технической информации.



